---
title: "Test-Retest Reliability"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TRTR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Illustration of Test-Retest Reliability

## To Do: 
Figure out why MAR drop-out torpedoes the ICC(2,1) values!

```{r output_dir, echo = F}
print.dir = "C:/Users/ciaconangelo/OneDrive - OPEN Health/Documents/misc_R_table_output"
```

## Required R packages
```{r setup}
library(COA34)
# In addition, you'll need the following
library(psych)
```


## Generate data
```{r generate}

set.seed(5122021)
sim.out <- COA34::sim_pro_dat(N=1e3,
                        polychor.value = 0.4,
                        corr = 'ar1',
                        cor.value = 0.8,
                        var.values = c(5))

dat <- sim.out$dat


# You already have the PGIS_bl and PGIS_delta in the generated data,
# you wouldn't have that in a real dataset, so drop that first
dat <- dat[, !(colnames(dat) %in% c('PGIS_bl', 'PGIS_delta'))]
# This makes the resf of this more realistic

```

## Implement drop-out

```{r missing}

dat <- COA34::dropout(dat = dat,
               type_dropout  = c('mcar', 'mar', 'mnar'),
               prop.miss = 0.5,
               stochastic.component = 0.2)


```


## Compute PGIS delta

```{r pgis_delta}
dat <- COA34::compute_anchor_delta(dat = dat,
                                   subject.id = 'USUBJID',
                                   time.var = 'Time',
                                   anchor = 'PGIS')

```


## Compute PRO Score delta

```{r score_delta}
dat <- COA34::compute_change_score(dat = dat,
                                   subject.id = 'USUBJID',
                                   time.var = 'Time',
                                   score = c('Y_comp', 'Y_mcar', 'Y_mar', 'Y_mnar'))


```




## Test-Retest Reliability

Use the function to compute the ICC(2,1). Note that this is just a wrapper for the `psych` R package `icc` function. This computes the table and outputs the relevant information. 

```{r trtr1}
# Test Retest Reliability
icc <- COA34::compute_icc21(dat = dat,
                            PRO.score = c('Y_comp', 'Y_mcar', 'Y_mar', 'Y_mnar'),
                            time.var = 'Time',
                            subject.id = 'USUBJID',
                            anchor = 'PGIS_delta',
                            stable.score = 0, 
                            first.timepoint = 'Time_1', 
                            second.timepoint = 'Time_2')

```

Print the table out:

```{r trtr2}
library(R2Word)

R2Word::dump_df_mat_to_file(out = icc$icc.21,
                            decimals = c(2, 0, 0), 
                            table.title = 'ICC(2,1) - Vignette Illustration', 
                            table.footnote = '**All data simulated',
                            file.name = 'trtr_vig_icc21', 
                            print.dir = print.dir)


```

## Compare to Generated Value
The key here is that we are generating the data, so we can confirm that we are recovering the generating parameter (i.e., we are doing it right). Below is the correlation matrix of the residuals used to generate the PRO scores.  

```{r gen_param}

sim.out$cor.mat

```

This is an ar1 autoregressive correlation structure, with the correlation equal to 0.8.The generating value of the correlation between timepoint 1 and 2 was 0.8. Our estimates come reasonably close to recovering this value. 

### Shell Tables
If you're putting together shell tables, use the function `shell_table`, specifying that you want columns 2 and 3 to be converted to x instead of the numeric values. 


```{r trtr3}

st <- R2Word::shell_table(out = icc$icc.21, decimals = c(2, 0), cols = c(2, 3))
                           
R2Word::dump_df_mat_to_file(out = st,
                            decimals = 0, 
                            table.title = 'ICC(2,1) - Vignette Illustration', 
                            table.footnote = '**All data simulated',
                            file.name = 'trtr_vig_icc21_shell_tables', 
                            print.dir = print.dir)



```

### Line Plots to visualize TRTR

Two possible ways to visualize the data. The first is follow up plotted against baseline:

```{r trtr_plot1}
library(ggplot2)

range <- range(dat$Y_comp[dat$Time%in%c("Time_1", "Time_2")])
range <- c(floor(range[1]), ceiling(range[2]))

ggplot(dat[dat$Time=="Time_2",], 
       aes(x = Y_comp_bl, y = Y_comp)) +
  geom_point(alpha = .5) +
  theme_minimal() +
  geom_abline()+
  labs(title = "Time 2 vs Time 1 PRO Scores",
       x = "Time 1", y = "Time 2")+
  xlim(range)+ylim(range)


```


The second way to visualize is difference in score plotted against average score:

```{r trtr_plot1}

dels <- dat$Y_comp_delta[dat$Time=="Time_2"]

ggplot(dat[dat$Time=="Time_2",], 
       aes(x =(Y_comp_bl+ Y_comp)/2, y = Y_comp_delta)) +
  geom_point(alpha = .5) +
  theme_minimal() +
  geom_abline(slope = 0)+
  labs(title = "Change in Score vs Average Score \nfor PRO measure at Time 1 and Time 2",
       x = "Average PRO Score", y = "Change in PRO Score")+
  geom_hline(yintercept = qnorm(c(.025, .975), sd = sd(dels), mean = mean(dels)),
              linetype = "dashed")#add 95% "limits of agreement"



```


## MAR Drop-out

The more interesting component of this is observing how non-random missingness impacts the ICC(2,1) values. Let's look at TRTR at timepoint 4, where there is 50% drop out. 

```{r trtr4}
# Test Retest Reliability
icc <- COA34::compute_icc21(dat = dat,
                            PRO.score = c('Y_comp', 'Y_mcar', 'Y_mar', 'Y_mnar'),
                            time.var = 'Time',
                            subject.id = 'USUBJID',
                            anchor = 'PGIS_delta',
                            stable.score = 0, 
                            first.timepoint = 'Time_1', 
                            second.timepoint = 'Time_4')

sim.out$cor.mat

R2Word::dump_df_mat_to_file(out = icc$icc.21,
                            decimals = c(2, 0, 0), 
                            table.title = 'Timepoint 4, ICC(2,1) - Vignette Illustration', 
                            table.footnote = '**All data simulated',
                            file.name = 'trtr_vig_icc21_t4', 
                            print.dir = print.dir)


```

As you can see, this absolutely torpedoes the estimates. The generating parameter is 0.512 (from the autoregressive correlation structure), see matrix. The estimates with complete data are close. However, MAR and MNAR drop-out severely attenuate these estimates. 
